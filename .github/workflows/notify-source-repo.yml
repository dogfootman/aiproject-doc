name: Sync Doc Status to Source Repo

on:
  issues:
    types: [labeled]

env:
  SOURCE_REPO: dogfootman/aiproject-src

jobs:
  # ìë™í™” A: Doc spec-complete â†’ Source ready-to-implement
  spec-complete-notify:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'spec-complete'

    steps:
      - name: Extract Source Issue Number
        id: extract
        run: |
          BODY="${{ github.event.issue.body }}"
          # aiproject-src#N ë˜ëŠ” issues/N í˜•ì‹ì—ì„œ ë²ˆí˜¸ ì¶”ì¶œ
          SOURCE_ISSUE=$(echo "$BODY" | grep -oE 'aiproject-src#[0-9]+|aiproject-src/issues/[0-9]+' | grep -oE '[0-9]+' | head -1)
          if [ -z "$SOURCE_ISSUE" ]; then
            SOURCE_ISSUE=$(echo "$BODY" | grep -oE 'issues/[0-9]+' | grep -oE '[0-9]+' | head -1)
          fi
          echo "source_issue=$SOURCE_ISSUE" >> $GITHUB_OUTPUT
          echo "Found source issue: $SOURCE_ISSUE"

      - name: Update Source Issue
        if: steps.extract.outputs.source_issue != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.SOURCE_REPO_TOKEN }}
          script: |
            const [owner, repo] = process.env.SOURCE_REPO.split('/');
            const issueNumber = ${{ steps.extract.outputs.source_issue }};
            const docIssueUrl = '${{ github.event.issue.html_url }}';

            // spec-pending ë¼ë²¨ ì œê±°
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: issueNumber,
                name: 'spec-pending'
              });
            } catch (e) {
              console.log('spec-pending label not found');
            }

            // ready-to-implement ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: ['ready-to-implement']
            });

            // ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `## âœ… Spec ì‘ì„± ì™„ë£Œ

Doc Repoì—ì„œ Spec ë¬¸ì„œ ì‘ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

- **Doc Issue**: ${docIssueUrl}

### ìƒíƒœ ë³€ê²½
- \`spec-pending\` â†’ \`ready-to-implement\`

### ë‹¤ìŒ ë‹¨ê³„
1. ë¸Œëœì¹˜ ìƒì„± í›„ êµ¬í˜„ ì‹œì‘
2. êµ¬í˜„ ì‹œì‘ ì‹œ \`in-progress\` ë¼ë²¨ ì¶”ê°€
3. PR ìƒì„± ì‹œ ì´ ì´ìŠˆ ì—°ê²°: \`Closes #${issueNumber}\`

---
ğŸ¤– *ìë™ ìƒì„±ë¨*`
            });

            console.log(`Updated source issue #${issueNumber}`);
