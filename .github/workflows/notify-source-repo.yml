name: Notify Source Repo on Spec Complete

on:
  issues:
    types: [closed, labeled]

env:
  SOURCE_REPO: dogfootman/aiproject-src

jobs:
  notify-ready:
    runs-on: ubuntu-latest
    # spec ë¼ë²¨ì´ ìˆê³ , completed ë¼ë²¨ì´ ì¶”ê°€ë˜ì—ˆê±°ë‚˜ ì´ìŠˆê°€ ë‹«íŒ ê²½ìš°
    if: |
      contains(github.event.issue.labels.*.name, 'spec') &&
      (contains(github.event.issue.labels.*.name, 'completed') || github.event.action == 'closed')

    steps:
      - name: Extract Source Issue Number
        id: extract
        run: |
          # Issue bodyì—ì„œ Source Issue ë²ˆí˜¸ ì¶”ì¶œ
          BODY="${{ github.event.issue.body }}"
          SOURCE_ISSUE=$(echo "$BODY" | grep -oP 'issues/\K[0-9]+' | head -1)
          echo "source_issue=$SOURCE_ISSUE" >> $GITHUB_OUTPUT
          echo "Found source issue: $SOURCE_ISSUE"

      - name: Add Label to Source Issue
        if: steps.extract.outputs.source_issue != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.SOURCE_REPO_TOKEN }}
          script: |
            const [owner, repo] = process.env.SOURCE_REPO.split('/');
            const issueNumber = ${{ steps.extract.outputs.source_issue }};

            // ready-to-implement ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: ['ready-to-implement']
            });

            // spec-pending ë¼ë²¨ ì œê±°
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: issueNumber,
                name: 'spec-pending'
              });
            } catch (e) {
              console.log('spec-pending label not found, skipping removal');
            }

            // ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `## âœ… Spec ì‘ì„± ì™„ë£Œ

            Doc Repoì—ì„œ Spec ë¬¸ì„œ ì‘ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

            - **Spec Issue**: ${{ github.event.issue.html_url }}

            ### êµ¬í˜„ ì‹œì‘ ê°€ì´ë“œ

            1. \`develop\` ë¸Œëœì¹˜ì—ì„œ ìƒˆ ë¸Œëœì¹˜ ìƒì„±
               \`\`\`bash
               git checkout develop
               git pull origin develop
               git checkout -b fix/${issueNumber}-description
               \`\`\`

            2. Spec ë¬¸ì„œ ì°¸ê³ í•˜ì—¬ êµ¬í˜„

            3. PR ìƒì„± ì‹œ ì´ ì´ìŠˆ ì—°ê²°
               \`\`\`
               Closes #${issueNumber}
               \`\`\`

            ---
            ğŸ¤– *ì´ ì½”ë©˜íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
            `
            });
